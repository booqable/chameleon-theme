{% comment %}

  This snippet is used for loading non-critical JavaScript files

  scripts - [array of script URLs] *required

  Usage:

  {%- render 'scripts-non-critical',
      scripts: array
  -%}

{% endcomment %}

{%- if scripts != blank -%}
  {%- assign array = scripts | split: ', ' -%}
  {%- assign urls = '' -%}

  {%- for script in array -%}
    {%- assign url = script | strip | asset_url -%}
    {%- if forloop.first -%}
      {%- assign urls = url -%}
    {%- else -%}
      {%- assign urls = urls | append: ', ' | append: url -%}
    {%- endif -%}
  {%- endfor -%}

  <script>
    window.addEventListener('load', () => {
      const loadScripts = () => {
        const scriptsString = '{{ urls }}',
              scripts = scriptsString.split(', ')

        scripts.forEach(src => {
          if (!src || src.trim() === '') return
          const script = document.createElement('script')
          script.src = src.trim()
          script.defer = true
          script.onerror = () => console.error(`Failed to load script: ${src}`)
          document.body.appendChild(script)
        })
      }

      'requestIdleCallback' in window
        ? window.requestIdleCallback(loadScripts, { timeout: 4000 })
        : setTimeout(loadScripts, 1000)
    }, { once: true })
  </script>
{%- endif -%}
